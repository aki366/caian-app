name: Get outdated wiki files

on:
  schedule:
    - cron: '07 15 * * *' # This runs every day at 00:07 JST

jobs:
  check-wiki:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout wiki repository
      uses: actions/checkout@v2
      with:
        repository: ${{ github.repository }}.wiki

    - name: Check for old updates and add to the list
      run: |
        # Clear the SortedWikiPages.md file
        echo "" > SortedWikiPages.md

        # Add header to the file
        echo "| Pages | Last update |" >> SortedWikiPages.md
        echo "| --- | --- |" >> SortedWikiPages.md

        OFFSET_DAYS=10
        ONE_DAY_AGO_DATE=$(TZ="Asia/Tokyo" date -d "$OFFSET_DAYS days ago" +'%Y-%m-%d %H:%M:%S')
        echo "ONE_DAY_AGO_DATE: "$ONE_DAY_AGO_DATE

        for file in *; do
          FILE_DATE=$(git log -1 --pretty=format:'%ad' --date=format:'%Y-%m-%d %H:%M:%S' -- "$file")
          if [[ ! "$file" == "SortedWikiPages.md" ]] && [[ "$FILE_DATE" < "$ONE_DAY_AGO_DATE" ]]; then
            echo "| [$file](https://github.com/aki366/caian-app/wiki/$file) | $(echo $FILE_DATE | cut -d ' ' -f 1) |" >> SortedWikiPages.md
            echo " FILE_DATE: "$FILE_DATE " " $file
          fi
        done

        # If changes exist, commit and push
        if [[ `git status --porcelain` ]]; then
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add SortedWikiPages.md
          git commit -m "Update sorted wiki pages list"
          git push origin master
        fi
