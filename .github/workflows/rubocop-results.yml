name: RuboCop Lint Check

on:
  pull_request:
    branches:
      - main
    paths:
      - 'apps/backend/**'

env:
  GH_TOKEN: ${{ github.token }} # ghコマンドを使用する場合はenvでtokenの設定が必要

jobs:
  rubocop:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Exit if No Ruby Files for Linting
        run: |
          cd apps/backend
          FILE_LIST=$(gh pr diff ${{ github.event.number }} --name-only | grep '\.rb$')
          echod $FILE_LIST
          if [ -z "$FILE_LIST" ]; then
            echo "No .rb files to analyze"
            exit 0
          else
            echo ""
            echo "Analyzing the following Ruby files"
            echo "$FILE_LIST"
          fi

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0.3

      - name: Install dependencies
        run: |
          gem install bundler
          cd apps/backend
          bundle install

      - name: Run RuboCop
        run: |
          cd apps/backend
          gh pr diff ${{ github.event.number }} --name-only |
          grep '\.rb$' |
          xargs -I {} sh -c '[ -f "{}" ] && echo "{}"' |
          xargs --no-run-if-empty bundle exec rubocop --force-exclusion
